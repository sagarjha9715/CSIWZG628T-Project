---
- name: Convert comma-separated disk sizes to list
  set_fact:
    disk_sizes_list: "{{ additional_disk_sizes.split(',') | map('trim') | map('int') }}"

- name: Debug disk sizes list
  debug:
    var: disk_sizes_list

- name: Create and attach data disks
  azure_rm_manageddisk:
    resource_group: "{{ rg_name }}"
    name: "{{ hostname }}_data_disk_{{ item }}"
    disk_size_gb: "{{ item }}"
    create_option: "empty"
    storage_account_type: "Standard_LRS"
  with_items: "{{ disk_sizes_list }}"
  register: data_disks

- name: Attach data disks to the virtual machine
  azure_rm_virtualmachine:
    resource_group: "{{ rg_name }}"
    name: "{{ hostname }}"
    data_disks: "{{ dict_kv_lun }}"
  vars:
    dict_kv_lun: |
      {% set luns = [] %}
      {% for i in range(0, data_disks.results | length) %}
        {% set _ = luns.append({'id': data_disks.results[i]['state']['id'], 'lun': i}) %}
      {% endfor %}
      {{ luns }}
  when: data_disks is defined
